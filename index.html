<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    const laserPowerSlider = document.getElementById('laser-power');
    const entropySlider = document.getElementById('medium-entropy');
    const laserValueDisplay = document.getElementById('laser-power-value');
    const entropyValueDisplay = document.getElementById('entropy-value');

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±
    laserPowerSlider.oninput = function() { laserValueDisplay.innerHTML = this.value; }
    entropySlider.oninput = function() { entropyValueDisplay.innerHTML = this.value; }

    // Ø­ÙØ¸ Ù…ÙØªØ§Ø­ API ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
    function saveAPIKey() {
        const key = document.getElementById('api-key-input').value;
        if (key) {
            localStorage.setItem('obd_api_key', key);
            updateAPIStatus(true);
            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ù†Ø¬Ø§Ø­!');
        }
    }

    function updateAPIStatus(connected) {
        const statusDiv = document.getElementById('api-status');
        const aiStatus = document.getElementById('ai-status');
        if (connected) {
            statusDiv.className = 'api-status api-connected';
            statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ';
            aiStatus.innerHTML = 'ğŸŸ¢ Ø¬Ø§Ù‡Ø²';
        }
    }

    // Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¬Ø±Ø¨Ø©
    async function startExperiment() {
        const apiKey = localStorage.getItem('obd_api_key');
        if (!apiKey) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ.');
            return;
        }

        // ØªØ´ØºÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const loading = document.getElementById('loading-overlay');
        loading.classList.add('active');
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©
        const data = {
            laser: laserPowerSlider.value,
            entropy: entropySlider.value,
            model: document.getElementById('ai-model-select').value
        };

        try {
            // Ù…Ø­Ø§ÙƒØ§Ø© ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ù†ØªØ§Ø¦Ø¬ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
            const infoTransfer = (data.laser / (data.entropy * 0.5)).toFixed(2);
            const boundaryStability = (100 - (data.entropy * 0.8)).toFixed(2);

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            document.querySelector('.metric-value').innerText = infoTransfer;
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù€ OpenRouter
            const response = await axios.post('https://openrouter.ai/api/v1/chat/completions', {
                model: data.model,
                messages: [{
                    role: "user",
                    content: `Ø¨ØµÙØªÙƒ Ù…Ø³Ø§Ø¹Ø¯ Ø¹Ø§Ù„Ù… ÙÙŠØ²ÙŠØ§Ø¡ØŒ Ø­Ù„Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù†Ø¸Ø§Ù… OBD: Ø´Ø¯Ø© Ø§Ù„Ù„ÙŠØ²Ø± ${data.laser}mWØŒ Ø§Ù„Ø¥Ù†ØªØ±ÙˆØ¨ÙŠØ§ ${data.entropy}. Ø§Ø­Ø³Ø¨ ÙƒÙØ§Ø¡Ø© Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ø§Ù„Ù€ Bulk Ø¥Ù„Ù‰ Ø§Ù„Ù€ Boundary.`
                }]
            }, {
                headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" }
            });

            addMessage('ai', response.data.choices[0].message.content);

        } catch (error) {
            addMessage('ai', "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ù…ÙØªØ§Ø­ API.");
        } finally {
            loading.classList.remove('active');
        }
    }

    function addMessage(type, text) {
        const content = document.getElementById('analysis-content');
        const msg = document.createElement('div');
        msg.className = 'analysis-message';
        msg.innerHTML = `
            <div class="message-header ${type}-message-header">
                <i class="fas fa-${type === 'ai' ? 'robot' : 'user'}"></i> 
                ${type === 'ai' ? 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…' : 'Ø§Ù„Ø¨Ø§Ø­Ø« Ø¹Ù…Ø§Ø±'}
            </div>
            <div class="message-content">${text}</div>
        `;
        content.appendChild(msg);
        content.scrollTop = content.scrollHeight;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.onload = () => {
        if(localStorage.getItem('obd_api_key')) updateAPIStatus(true);
    };
</script>
